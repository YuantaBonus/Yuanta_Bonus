<!doctype>
<html>
	
<head>
	<meta charset="UTF-8">
	<title>Credit Rating on Ethereum</title>
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<link type="text/css" rel="stylesheet" href="css/style.css"/>
</head>
<script type="text/javascript" src="./node_modules/bignumber.js/bignumber.min.js"></script>
<script type="text/javascript" src="./dist/web3-light.js"></script>
<script type='text/javascript'>
	
	var Web3 = require('web3');
    var web3 = new Web3();
	web3.setProvider(new web3.providers.HttpProvider("http://140.113.72.54:8545"));
	web3.eth.defaultAccount = web3.eth.accounts[1];
	web3.personal.unlockAccount(web3.eth.defaultAccount, 'tony70431', 300);
	
	// creation of contract object
	var MyContract = web3.eth.contract([ { "constant": true, "inputs": [ { "name": "", "type": "int256" } ], "name": "deals", "outputs": [ { "name": "number", "type": "int256", "value": "0" }, { "name": "buyer", "type": "address", "value": "0x0000000000000000000000000000000000000000" }, { "name": "seller", "type": "address", "value": "0x0000000000000000000000000000000000000000" }, { "name": "buyerRated", "type": "bool", "value": false }, { "name": "sellerRated", "type": "bool", "value": false }, { "name": "bothRated", "type": "bool", "value": false } ], "payable": false, "type": "function" }, { "constant": false, "inputs": [ { "name": "dealnum", "type": "int256" } ], "name": "normalrate", "outputs": [], "payable": false, "type": "function" }, { "constant": false, "inputs": [ { "name": "dealnum", "type": "int256" } ], "name": "badrate", "outputs": [], "payable": false, "type": "function" }, { "constant": false, "inputs": [ { "name": "dealnum", "type": "int256" } ], "name": "goodrate", "outputs": [], "payable": false, "type": "function" }, { "constant": false, "inputs": [ { "name": "buyer", "type": "address" }, { "name": "seller", "type": "address" } ], "name": "addDeal", "outputs": [], "payable": false, "type": "function" }, { "constant": true, "inputs": [ { "name": "", "type": "address" } ], "name": "users", "outputs": [ { "name": "user", "type": "address", "value": "0x0000000000000000000000000000000000000000" }, { "name": "goodrating", "type": "int256", "value": "0" }, { "name": "normalrating", "type": "int256", "value": "0" }, { "name": "badrating", "type": "int256", "value": "0" }, { "name": "totalrating", "type": "int256", "value": "0" } ], "payable": false, "type": "function" }, { "anonymous": false, "inputs": [ { "indexed": false, "name": "id", "type": "int256" }, { "indexed": false, "name": "sendFrom", "type": "address" }, { "indexed": false, "name": "buyer", "type": "address" }, { "indexed": false, "name": "seller", "type": "address" } ], "name": "addDealEvent", "type": "event" } ]); // contract abi
	
	myContractAddress = '0x9B160ED48628D5Faf6233cf6b9dED7C930680B3A'; //Credit Rating 9b16
	var myContractInstance = MyContract.at(myContractAddress);	// initiate contract for an address
	
	function addDeal(){
		var Baddress = document.getElementById('BuyerAddress').value;
		var Saddress = document.getElementById('SellerAddress').value;
		console.log("address:", Baddress, Saddress);
		var res = myContractInstance.addDeal(
			Baddress,
			Saddress,
			{
				from: web3.eth.defaultAccount,
				'gas': myContractInstance.addDeal.estimateGas() *5 
			},
			function(err, result) {
				if (!err){
					console.log(result);
					console.log('success');
				}
				else {
					console.log(err);
				}
			}
		);
		alert(res);
		document.getElementById("result").innerText = Baddress + "\n" + Saddress + "\n" + "transaction result:\n" + res;
	}
	
	function searchDeal(){
		var param = parseInt(document.getElementById("query").value);
        var res = myContractInstance.deals(param);
		document.getElementById("dealresult_buyer").innerText = "buyer's address:\n" + res[1];
		document.getElementById("dealresult_seller").innerText = "seller's address:\n" + res[2];
	}
	
	function Rating(){
		var param = parseInt(document.getElementById("dealNum").value);
		if(isNaN(param)){
			alert("please type the deal's number");
			return;
		}
		var Rating = document.getElementById('form');
		var check = false;
		for(var i = 0 ; i<Rating.rate.length; i++){
			if(Rating.rate[i].checked){
				check = true;
				if(Rating.rate.value==3){
					var res = myContractInstance.goodrate(
					param,
						{from: web3.eth.defaultAccount, 
						'gas': myContractInstance.addDeal.estimateGas() *5 
					}, 
					function(err, result) {
						if (!err)
							console.log(result);
					});
				}		
				if(Rating.rate.value==2){
					var res = myContractInstance.normalrate(
						param,
						{
							from: web3.eth.defaultAccount,
							'gas': myContractInstance.addDeal.estimateGas() *5 
						},
						function(err, result) {
							if (!err)
								console.log(result);
					});
				}
				if(Rating.rate.value==1){
					var res = myContractInstance.badrate(
						param,
						{
							from: web3.eth.defaultAccount,
							'gas': myContractInstance.addDeal.estimateGas() *5 
						},
						function(err, result) {
							if (!err)
								console.log(result);
					});
				}
			}
		}
		if(!check)
				alert("please choose a rate to give");
	}
	
	function searchUser(){
		var param = document.getElementById("user").value;
        var res = myContractInstance.users(param);
		
        document.getElementById("userresult_user").innerText = "User:\n" + res[0];
		document.getElementById("userresult_good").innerText = "\nRate:\ngood x " + res[1];
		document.getElementById("userresult_normal").innerText = "normal x " + res[2];
		document.getElementById("userresult_bad").innerText = "bad x " + res[3];
		document.getElementById("userresult_total").innerText = "\nTotal: " + res[4];
	}
	
	
	function checkUserDeal(){
		var param = document.getElementById("userdeal").value;
        var res = contracts["CreditRating"].contract.checkUserDeal(param);
        document.getElementById("userdeal_user").innerText = "User:\n" + param;
		document.getElementById("userdeal_rated").innerText = "List of User's deal:\n" + res[0] + res[1];
	}
	

</script>
<body>
	
<div class="header">
	<h1>Credit Ratings</h1>
</div>
<div class="main">	
	<div class="part">
		<a>*Add Deal</a><br>
		<div class="padding">
			buyer's address:<input type='address' id='BuyerAddress'><br>
			seller's address:<input type='address' id='SellerAddress'><br>
			<button onclick='addDeal()'>Submit</button>
			<div id='result'></div>
		</div>
	</div>
	<div class="part">
		<a>*Search Deal</a><br>
		<div class="padding">
		deal's number:<input type="number" id="query" onkeyup='searchDeal()'><br>
		<div id='dealresult_buyer'></div>
		<div id='dealresult_seller'></div>
		</div>
	</div>
	<div class="part">
		<a>*Rate the dealer</a><br>
		<div class="padding">
			deal's number:<input type='number' id='dealNum'><br>
			rate to give:<form id='form'><input type='radio' name='rate' id='rate' value='3'>good
								<input type='radio' name='rate' id='rate' value='2'>normal
			<input type='radio' name='rate' id='rate' value='1'>bad
			<br><button onclick='Rating()'>Submit</button></form>
		</div>
	</div>
	<div>
		<a>*Search User's Credit</a><br>
		<div class="padding">
			user's address:<input type="address" id="user" onkeyup='searchUser()'><br>
			<div id='userresult_user'></div>
			<div id='userresult_good'></div>
			<div id='userresult_normal'></div>
			<div id='userresult_bad'></div>
			<div id='userresult_total'></div>
		</div>		
	</div>
	<!-- <div class="part">
		<a>*Check User's deals</a><br>
		<div class="padding">
			user's address:<input type="address" id="userdeal"><br>
			<button onclick='checkUserDeal()'>Submit</button>
			<div id='userdeal_user'></div><br>
			<div id='userdeal_rated'></div>
		</div>	
	</div> -->
</div>
</body>
</html>
